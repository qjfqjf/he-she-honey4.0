<template>
	<view class="b-content p-2">
		<z-nav-bar title="血氧月报">
			<view slot="right" class="p-2" @click="handleDevelop">预警规则</view>
		</z-nav-bar>
		<public-module @getDate="getDate"></public-module>
		<TimeRage @getDate="getDate"></TimeRage>
		<view class="historyCard mb-3" v-for="(item,index) in dataList" :key="index">
			<view class="top d-flex j-sb mb-2">
				<view class="time">
					{{item.test_time}}
				</view>
			</view>
			<view class="data d-flex j-sb">
				<view class="bloodOxygen">
					血氧：{{item.blood_oxygen}}
				</view>
				<view class="PI">
					PI：{{item.pi}} 
				</view>
				<view class="rate">
					<!-- ↓ -->
					脉率：{{item.pulse_rate}}
				</view>
			</view>
		</view>

		<view>
			<u-button @click="test">aaa</u-button>
		</view>


	</view>
</template>

<script>
	import TimeRage from '../components/timeRage/TimeRage.vue'
	import UButton from "../../../uni_modules/uview-ui/components/u-button/u-button.vue"
	import dayjs from '../utils/dayjs.js'
	// import isBetween from 'dayjs/plugin/isBetween'
	export default {
		components: {
			UButton,
			TimeRage
		},
		data() {
			return {
				date:{
					startTime:this.getFirstDayOfMonth().format('yyyy-MM-dd'),
					endTime:this.getLastDayOfMonth().format('yyyy-MM-dd'),
				},
				allDataList:[],
				dataList: [
					{
						test_time: "2023-3-20 15:30",
						blood_oxygen: 168,
						pi: 98,
						pulse_rate: 81
					},
					{
						test_time: "2023-4-29 15:30",
						blood_oxygen: 168,
						pi: 98,
						pulse_rate: 81
					},
					{
						test_time: "2021-3-29 15:30",
						blood_oxygen: 168,
						pi: 98,
						pulse_rate: 81
					},
					{
						test_time: "2023-3-27 15:30",
						blood_oxygen: 168,
						pi: 98,
						pulse_rate: 81
					}
				]
			};
		},
		created() {
			dayjs.extend(isBetween)
		},
		onLoad() {
			dayjs.extend(isBetween)
			//this.getHistoryList();
			//测试
			// console.log(dayjs())
			// console.log(dayjs('2016-10-30').isBetween('2016-01-01', '2016-10-30', 'day', '[]'))
			// console.log(new Date(this.dataList[0].test_time).format('yyyy-MM-dd'))
			// console.log(dayjs(new Date(this.dataList[0].test_time).format('yyyy-MM-dd')).isBetween(this.date.startTime,this.date.endTime,'day','[]'))
		},
		methods: {
			//测试子组件传来的值是否是正确的
			test(){
				console.log("start"+this.date.startTime)
				console.log("end"+this.date.endTime)
			},
			// 获取当前月的最后一天
			getLastDayOfMonth() {
				const now = new Date();
				const year = now.getFullYear();
				const month = now.getMonth() + 1; // 月份从0开始，需要加1
				const lastDay = new Date(year, month, 0).getDate(); // 0表示上一个月的最后一天，即当前月的最后一天
				const lastDayOfMonth = new Date(year, month - 1, lastDay);
				return lastDayOfMonth;
			},
			// 获取当前月的第一天
			getFirstDayOfMonth() {
				const today = new Date();
				const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
				return firstDayOfMonth
			},

			//从子组件获取开始和结束时间，并且更新数据
			getDate(date){
				this.date = date;
				//清空数组内数据
				this.allDataList = [];
				//筛选出符合条件的数据
				for(var i in this.allDataList){
					//判断数据是否在所选日期范围内
					if(dayjs(new Date(this.allDataList[i].test_time).format('yyyy-MM-dd')).isBetween(this.date.startTime,this.date.endTime, 'day', '[]')){
						this.dataList.push(this.allDataList[i])
					}
				}
			},

			handleDevelop() {
				this.$refs.uToast.show({
					message: '开发中...'
				})
			},
			//查询血氧历史记录
			getHistoryList() {
				this.$http.post('/platform/dataset/search_read', {
					model: "oximeter",
					fields: [
						"name",
						"numbers",
						"owner",
						"blood_oxygen",
						"pi",
						"pulse_rate",
						"input_type",
						"test_time"
					]
				}).then(res => {
					this.allDataList = res.result.records
				})
			},

		}
	}
</script>

<style lang="scss">
	.b-content {
		.timeRange {
			.startTime {
				color: #2fa290;
			}

			.endTime {
				color: #2fa290;
			}
		}

		.historyCard {
			padding: 40rpx;
			border-radius: 16rpx;
			background-color: #fff;
			box-shadow: inset 0 3px 0 hsla(0, 0, 0, 0), 0 3px 3px hsla(0, 0, 0, .2);

			.top {

				.time {
					color: #666;


				}
			}

			.data {

				.bloodOxygen,
				.PI {

					color: #ffd661;

				}
			}
		}
	}
</style>